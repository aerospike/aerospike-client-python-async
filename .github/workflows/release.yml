name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. 0.2.0) — must match pyproject.toml and Cargo.toml'
        required: true
        type: string
      publish_pypi:
        description: 'Publish to PyPI?'
        required: false
        type: choice
        options:
          - 'no'
          - 'test.pypi.org'
          - 'pypi.org'
        default: 'no'

permissions:
  contents: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Validate version matches pyproject.toml
        run: |
          PYPROJECT_VERSION=$(python3 -c "
          import tomllib, pathlib
          data = tomllib.loads(pathlib.Path('pyproject.toml').read_text())
          print(data['project']['version'])
          ")
          echo "pyproject.toml version: $PYPROJECT_VERSION"
          if [ "$PYPROJECT_VERSION" != "${{ inputs.version }}" ]; then
            echo "::error::Version mismatch: pyproject.toml has '$PYPROJECT_VERSION' but release requested '${{ inputs.version }}'"
            exit 1
          fi

      - name: Validate version matches Cargo.toml
        run: |
          CARGO_VERSION=$(grep -m1 '^version' Cargo.toml | sed 's/version = "\(.*\)"/\1/')
          echo "Cargo.toml version: $CARGO_VERSION"
          if [ "$CARGO_VERSION" != "${{ inputs.version }}" ]; then
            echo "::error::Version mismatch: Cargo.toml has '$CARGO_VERSION' but release requested '${{ inputs.version }}'"
            exit 1
          fi

      - name: Check tag does not already exist
        run: |
          if git rev-parse "v${{ inputs.version }}" >/dev/null 2>&1; then
            echo "::error::Tag v${{ inputs.version }} already exists"
            exit 1
          fi
          # Also check remote tags
          if git ls-remote --tags origin "refs/tags/v${{ inputs.version }}" | grep -q .; then
            echo "::error::Tag v${{ inputs.version }} already exists on remote"
            exit 1
          fi
          echo "Tag v${{ inputs.version }} is available"

      - name: Enforce stable releases from main
        run: |
          VERSION="${{ inputs.version }}"
          BRANCH="${{ github.ref_name }}"
          if echo "$VERSION" | grep -q -E "\-alpha|\-beta|\-rc"; then
            echo "Pre-release ($VERSION) — allowed from any branch ($BRANCH)"
          elif [ "$BRANCH" != "main" ]; then
            echo "::error::Stable releases must be cut from the main branch (current: $BRANCH)"
            exit 1
          else
            echo "Stable release ($VERSION) from main — OK"
          fi

  build:
    needs: validate
    uses: ./.github/workflows/build-test.yml

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Download all wheel artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          pattern: wheels-*
          merge-multiple: true
          path: dist

      - name: Download sdist
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: wheels
          path: dist

      - name: List release artifacts
        run: ls -lh dist/

      - name: Create and push tag
        run: |
          git tag "v${{ inputs.version }}"
          git push origin "v${{ inputs.version }}"

      - name: Create GitHub Release
        uses: step-security/action-gh-release@d45511d7589f080cf54961ff056b9705a74fd160 # v2.5.0
        with:
          tag_name: "v${{ inputs.version }}"
          name: "v${{ inputs.version }}"
          generate_release_notes: true
          files: dist/*

  publish:
    if: inputs.publish_pypi != 'no'
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Download all artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          pattern: wheels*
          merge-multiple: true
          path: dist

      - name: Publish to PyPI
        uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021 # v1.50.0
        env:
          MATURIN_PYPI_TOKEN: ${{ inputs.publish_pypi == 'pypi.org' && secrets.PYPI_API_TOKEN || secrets.TEST_PYPI_API_TOKEN }}
        with:
          command: upload
          args: --non-interactive --skip-existing dist/*
